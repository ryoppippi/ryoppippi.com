on:
  push:
  pull_request:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions: read-all
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - run: bun i
      - run: bun secretlint **/*
      - run: bun run lint

  check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions: read-all
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - run: bun i
      - run: bun run check

  lighthouse:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: bun i
      - name: Build
        run: bun run build
      - name: run Lighthouse CI
        run: |
          bun x @lhci/cli@$LHCI_CLI_VERCSION autorun --collect.staticDistDir=$COLLECT_SATIC_DIST_DIR --collect.url=$URL || echo "Lighthouse CI failed!"
        env:
          LHCI_CLI_VERCSION: 0.14.0
          COLLECT_SATIC_DIST_DIR: ${{ github.workspace }}/build
          URL: https://ryoppippi.com

  # build-and-deploy:
  #   needs:
  #     - lint
  #     - check
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       working-directory: ['./']
  #       project-deploy-name: ['ryoppippi-com']
  #       build-output-directory: ['build']
  #   timeout-minutes: 10
  #   permissions:
  #     contents: read
  #     deployments: write
  #     statuses: write
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: oven-sh/setup-bun@v1
  #       with:
  #         bun-version: latest
  #     - run: bun i --frozen-lockfile
  #     - name: build @ ${{ matrix.working-directory }}
  #       working-directory: ${{ matrix.working-directory }}
  #       run: bun run build
  #     - name: Deploy ${{ matrix.project-deploy-name }} to Cloudflare Pages
  #       uses: cloudflare/pages-action@v1
  #       id: cloudflare_pages_deploy
  #       with:
  #         accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  #         apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  #         projectName: ${{ matrix.project-deploy-name }}
  #         directory: ${{ matrix.build-output-directory }}
  #         gitHubToken: ${{ secrets.GITHUB_TOKEN }}
  #         workingDirectory: ${{ matrix.working-directory }}
  #         wranglerVersion: '3'
  #     - name: Add publish URL as commit status
  #       uses: actions/github-script@v6
  #       with:
  #         script: |
  #           const sha = context.payload.pull_request?.head.sha ?? context.sha;
  #           await github.rest.repos.createCommitStatus({
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             context: 'Deploy on Cloudflare Pages',
  #             description: 'Cloudflare Pages Deployement',
  #             state: 'success',
  #             sha,
  #             target_url: "${{ steps.cloudflare_pages_deploy.outputs.url }}",
  #           });
