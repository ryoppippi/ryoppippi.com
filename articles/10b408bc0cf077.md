---
title: "ä¿ºã® denols/tsserver(vtsls) å…±å­˜è¡“ for Neovim 2024"
emoji: "ðŸ¤"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["neovim", "deno", "typescript"]
published: true
publication_name: "vim_jp"
---

::: message
ã“ã®è¨˜äº‹ã¯[Vim é§…ä¼](https://vim-jp.org/ekiden/)ã® 5/10 ã®è¨˜äº‹ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

Neovimã®LSPã§Denoã®LSP(denols) ã¨ tsserver(vtsls)ã‚’å…±å­˜ã•ã›ã‚‹è©¦ã¿ã¯ã“ã‚Œã¾ã§å¹¾åº¦ã¨ãªãè¡Œã‚ã‚Œã¦ãã¾ã—ãŸã€‚
LSPã£ã¦ä½•ï¼Ÿã¨ã‹å•é¡Œæ„è­˜ã‚’è©³ã—ãçŸ¥ã‚ŠãŸã„ã€ã¨ã„ã†æ–¹ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

https://zenn.dev/kawarimidoll/articles/2b57745045b225
https://zenn.dev/mochi/articles/e6b2735108157c
https://zenn.dev/vim_jp/articles/69d26e3f7b0e35

è‡ªåˆ†ã‚‚ã“ã‚Œã¾ã§ä¸Šã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ãªãŒã‚‰è¨­å®šã‚’ã—ã¦ã„ãŸã®ã§ã™ãŒã€ã„ãã¤ã‹ä¸æº€ç‚¹ãŒã‚ã‚Šã¾ã—ãŸã€‚
- node.jsã®monorepoã®ä¸€éƒ¨ã§denoã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã€denoã®LSPã¨tsserver(vtsls)ã‚’å…±å­˜ã•ã›ã‚‹ã®ãŒé›£ã—ã„
- ã“ã‚Œã‚‰ã®è¨­å®šã§ã¯ã€`single_file_support = false`ã«ã—ã¦ã—ã¾ã£ã¦ã„ã‚‹ã®ã§ã€ä¾‹ãˆã°æ›¸ãæ¨ã¦ã®typescriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ãŸæ™‚ã«LSPãŒåŠ¹ã‹ãªã„

ãã“ã§ã€è‡ªåˆ†ãªã‚Šã®denoã¨tsserver(vtsls)ã®å…±å­˜è¡“ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

# åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã«ã¤ã„ã¦

å…ˆè¡Œç ”ç©¶ã¨ã—ã¦ã®[kyoh86æ°ã®è¨˜äº‹](https://zenn.dev/vim_jp/articles/69d26e3f7b0e35)ã‚’ãƒ™ãƒ¼ã‚¹ã«ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ„ã¿ã¾ã—ãŸã€‚

0. ç¾åœ¨é–‹ã„ã¦ã„ã‚‹Bufferã®ã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ã€denoé–¢é€£ã®ãƒ•ã‚¡ã‚¤ãƒ«^[ `deno.json` `deno.jsonc` `package.json` ãªã©ã€‚`package.json`ãŒdenoã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã®ã‚‚ã‚„ã‚„ã“ã—ã„ https://github.com/ryoppippi/dotfiles/blob/1c5bb5dcf827f4ca08120b6618031bd845f0ebde/nvim/lua/plugin/nvim-lspconfig/utils.lua#L104-L109] or nodeç‰¹æœ‰ã®ãƒ•ã‚¡ã‚¤ãƒ«^[`package-lock.json`ãªã© https://github.com/ryoppippi/dotfiles/blob/1c5bb5dcf827f4ca08120b6618031bd845f0ebde/nvim/lua/plugin/nvim-lspconfig/utils.lua#L111-L118] or git root^[`.git`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª] ãŒè¦‹ã¤ã‹ã‚‹ã¾ã§éšŽå±¤ã‚’ä¸ŠãŒã‚‹ã€‚
1. ã‚‚ã—ãã®éšŽå±¤ã«nodeç‰¹æœ‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆ -> denols ã‚’èµ·å‹•ã€‚tsserverã¯è½ã¨ã™ã€‚
2. ã‚‚ã— nodeç‰¹æœ‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ãŒã€`.vscode/settings.json` å†…ã§è¨±å¯ã•ã‚Œã¦ã„ãŸå ´åˆ -> denols ã‚’èµ·å‹•ã€‚tsserverã¯è½ã¨ã™ã€‚
3. ãã‚Œä»¥å¤–ã®å ´åˆ -> denolsã®`root_dir`ã«`nil`ã‚’è¨­å®šã—Single file modeã§èµ·å‹•ã€‚ã‚‚ã—tsserverãŒèµ·å‹•ã—ã¦ã„ãŸå ´åˆã¯è½ã¨ã™ã€‚

ã¨ã—ã¦ã„ã¾ã™ã€‚

å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

https://github.com/ryoppippi/dotfiles/blob/05ae64a18c348dd7989f1e67a98864948489f537/nvim/lua/plugin/nvim-lspconfig/servers/denols.lua#L6-L63

https://github.com/ryoppippi/dotfiles/blob/05ae64a18c348dd7989f1e67a98864948489f537/nvim/lua/plugin/nvim-lspconfig/servers/vtsls.lua#L43-L73

# ãƒ­ã‚¸ãƒƒã‚¯ã®è£œè¶³ã«ã¤ã„ã¦è«¸ã€…

## éšŽå±¤ã‚’ä¸ŠãŒã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŽ¢ã™æ–¹æ³•

ä»¥å‰ã¯kyoh86æ°ã®[climbdir.nvim](https://github.com/kyoh86/climbdir.nvim)ã‚’æ„›ç”¨ã—ã¦ã„ã¾ã—ãŸãŒã€ä»Šå›žã®å®Ÿè£…ã§ã¯Neovimã®luaé–¢æ•°ã§ã‚ã‚‹`vim.fs.root`ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

:::details vim.fs.rootã«ã¤ã„ã¦
https://neovim.io/doc/user/lua.html#vim.fs.root()

```markdown
vim.fs.root({source}, {marker})                                *vim.fs.root()*
    Find the first parent directory containing a specific "marker", relative
    to a buffer's directory.

    Example: >lua
        -- Find the root of a Python project, starting from file 'main.py'
        vim.fs.root(vim.fs.joinpath(vim.env.PWD, 'main.py'), {'pyproject.toml', 'setup.py' })

        -- Find the root of a git repository
        vim.fs.root(0, '.git')

        -- Find the parent directory containing any file with a .csproj extension
        vim.fs.root(0, function(name, path)
          return name:match('%.csproj$') ~= nil
        end)
<

    Parameters: ~
      â€¢ {source}  (`integer|string`) Buffer number (0 for current buffer) or
                  file path to begin the search from.
      â€¢ {marker}  (`string|string[]|fun(name: string, path: string): boolean`)
                  A marker, or list of markers, to search for. If a function,
                  the function is called for each evaluated item and should
                  return true if {name} and {path} are a match.

    Return: ~
        (`string?`) Directory path containing one of the given markers, or nil
        if no directory was found.
```
:::
ã“ã‚Œã§ã€æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‹ã¾ã§éšŽå±¤ã‚’ä¸ŠãŒã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¾ãŸã€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã—ã¦ãã®å­˜åœ¨ã‚’ç¢ºèªã™ã‚‹ã«ã¯ `vim.uv.fs_stat` ã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚
`fs_stat`ã®æˆ»ã‚Šå€¤ãŒ`nil`ã§ã‚ã‚Œã°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚

## `.vscode/settings.json`ã®èª­ã¿è¾¼ã¿

denoã®vscodeå‘ã‘æ‹¡å¼µæ©Ÿèƒ½ã¯`.vscode/settings.json`ã§ã®workspaceè¨­å®šã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

https://docs.deno.com/runtime/manual/references/vscode_deno/#workspace-folders

ã“ã“ã§ã¯
- `deno.enable` - denolsã‚’è¨±å¯ã™ã‚‹ã‹ã©ã†ã‹
- `deno.enablePaths` - è¨±å¯ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹ã®ãƒªã‚¹ãƒˆ

ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã—ã‹ã—ã€ã“ã‚Œã¯æ¨™æº–ã§ã¯Neovimã§ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚

ãã“ã§ã€neoconf.nvimã‚’ä½¿ã„ã¾ã™ã€‚
https://github.com/folke/neoconf.nvim

neoconf.nvimã¯jsonå½¢å¼ã§LSPã®è¨­å®šã‚’è¡Œã„ã€ã¾ãŸãã‚Œã‚’èª­ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚
ã¾ãŸ `.vscode/settings.json` ã‚‚ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚

ä¾‹ãˆã°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆã« `.vscode/settings.json`ã‚’ç½®ã„ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã€

```json
{
  "deno.enable": true,
  "deno.enablePaths": ["./apps/deno-project"]
}
```

ãã‚Œã‚’èª­ã¿è¾¼ã‚€ã‚ˆã†ã«è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã†ã™ã‚Œã°æ˜Žç¤ºçš„ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«deno or tsserverã®ä½¿ã„åˆ†ã‘ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ã¾ãŸã€å‰¯æ¬¡çš„ã«vscodeãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨å…±åŒä½œæ¥­ã™ã‚‹éš›ã«ã‚‚ä¾¿åˆ©ã§ã™ã€‚

ä»¥ä¸‹ã«èª­ã¿å–ã‚Šã®å®Ÿè£…ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚


https://github.com/ryoppippi/dotfiles/blob/05ae64a18c348dd7989f1e67a98864948489f537/nvim/lua/plugin/neoconf.lua#L7-L35
https://github.com/ryoppippi/dotfiles/blob/05ae64a18c348dd7989f1e67a98864948489f537/nvim/lua/plugin/nvim-lspconfig/servers/denols.lua#L27-L30

# ãŠã‚ã‚Šã«

ä»Šå¾Œã‚‚è‰²ã€…è©¦è¡ŒéŒ¯èª¤ã—ã¦ã„ãäºˆå®šã§ã™ãŒã€ã“ã®æ–¹æ³•ã§denoã¨tsserver(vtsls)ã‚’å…±å­˜ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã‚‚ã—ä½•ã‹å•é¡Œç‚¹ã‚„æ”¹å–„ç‚¹ãŒã‚ã‚Œã°ã€ãœã²æ•™ãˆã¦ãã ã•ã„ã€‚
