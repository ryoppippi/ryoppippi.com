---
title: "Hono RPCã¨SvelteKitã®ä½µç”¨ã«ã¤ã„ã¦"
emoji: "ğŸ“¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["tyescript", "sveltekit", "hono", "svelte", "cloudflare"]
published: true
---

# SvelteKit ã® Endpoint ã«ãŠã‘ã‚‹å‹å®‰å…¨ã‚’ã‚ãã‚‹è€ƒå¯Ÿ

SvelteKit ã§ Endpoint ã‚’æ›¸ãå ´åˆã€ç¾è¡Œã®å®Ÿè£…ã§ã¯ãã‚Œã‚’å‘¼ã³å‡ºã™ãŸã‚ã«ã¯ fetch é–¢æ•°ã‚’ç”¨ã„ã‚‹ã“ã¨ã«ãªã‚‹ã€‚

https://kit.svelte.jp/docs/routing#server

fetch é–¢æ•°ã‚’ç”¨ã„ã‚‹ã¨ã„ã†ã“ã¨ã¯ã¤ã¾ã‚Šã€Endpoint ã® URL ã‚„ request æ™‚ã®å¼•æ•°ã‚’æ¸¡ã™éƒ¨åˆ†ã¯å‹å®‰å…¨ãŒæ‹…ä¿ã•ã‚Œãªã„ã€‚
ãã®ãŸã‚ã€å€‹äººçš„ã«ã¯ã€Œæ¨™æº–ã®æ–¹æ³•ã§ Endpoint ã‚’è¨­è¨ˆ+fetchã€ã¯ãªã‚‹ã ã‘ä½¿ã„ãŸããªã„ãªã¨æ€ã£ã¦ã„ã‚‹ã€‚

ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å€™è£œã¯ä»¥ä¸‹ã®é€šã‚Š

- tRPC
- Hono RPC
- Garph + GQty

ã©ã‚Œã‚’ä½¿ã†ã¹ãã‹ã¯ä»¥ä¸‹ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’èª­ã‚“ã§ã„ãŸã ããŸã„ã€‚

https://twitter.com/ryoppippi/status/1664258993118740480
https://twitter.com/ryoppippi/status/1664259029227524097
https://twitter.com/ryoppippi/status/1664259247079653379

ã§ã€JS/TS ã§å®Œçµã™ã‚‹å ´åˆã¯ tRPC ãŒç­‹ãŒã„ã„ã®ã ãŒã€ä»–ã®è¨€èªã‹ã‚‰å©ãã¨ãªã‚‹ã¨ Garphï¼ˆGraphQLï¼‰ã‚‚ã—ãã¯ Honoï¼ˆRestï¼‰ãŒå€™è£œã«ä¸ŠãŒã‚‹ã€‚
Garph ã«é–¢ã—ã¦ã¯è©¦ã—ãŸã¨ã“ã‚ã€ã¾ã  GQty ã®å®Ÿè£…ãŒæˆç†Ÿã—ã¦ã„ãªã„ã®ã§ä»Šå¾Œã«æœŸå¾…ã‹ãªã¨ã„ã†ã¨ã“ã‚ã€‚
(ã¤ã¾ã‚Š GraphQL Schema ã¯å®šç¾©ãŒã§ãã‚‹ã‚“ã ãŒã€tRPC like ã«å‘¼ã³å‡ºã™éƒ¨åˆ†ãŒã¾ã )
https://github.com/ryoppippi/garph-sveltekit

ãªã®ã§ã€JS ã®ä¸–ç•Œã§ã¯å‹å®‰å…¨ã« Endpoint ã‚’å‘¼ã³å‡ºã—ã€ãã®ä»–ã®è¨€èªã‹ã‚‰ã‚‚é€šå¸¸ã® API ã¨ã—ã¦å©ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹ã«ã¯ã€ç¾çŠ¶ Hono ãŒæœ€é©è§£ã ã¨è€ƒãˆã¦ã„ã‚‹ã€‚

# Hono RPC + SvelteKit + Cloudflare ã®è½ã¨ã—ç©´

Hono RPC ã«ã¤ã„ã¦ã®è§£èª¬ã¯ä»¥ä¸‹ã‚’ã”è¦§ã„ãŸã ããŸã„ã€‚
https://zenn.dev/kosei28/articles/f4bac1ed2b64a7

https://zenn.dev/yusukebe/articles/53713b41b906de#rpcãƒ¢ãƒ¼ãƒ‰

kosei28 ã•ã‚“ã®è¨˜äº‹é€šã‚Šã«å®Ÿè£…ã™ã‚Œã° SvelteKit ã§ Hono ãŒå‹•ãã‚ˆã†ã«ãªã‚‹ã€‚
Node.js ãªã©ã§å‹•ã‹ã™å ´åˆã¯ã“ã‚Œã§å®Œç’§ã§ã‚ã‚ã†ã€‚

ãŒã€Cloudflare Pages/Workers ã§å‹•ã‹ã™ã¨ãã«ã¯æ³¨æ„ãŒå¿…è¦ãªã®ã§ã€å·®åˆ†ã‚’ãƒ¡ãƒ¢ãŒã‚ã‚Šã«ä»¥ä¸‹ã«ç¤ºã™ã€‚

## Route ã‚’ä½œã‚‹

kosei28 ã•ã‚“ã®è¨˜äº‹ã§ã¯`hooks.server.ts`ã§ãƒ«ãƒ¼ãƒˆã®åˆ†å²ã‚’æ›¸ã„ã¦ã„ã‚‹ã€‚

```ts :src/hooks.server.ts
import type { Handle } from "@sveltejs/kit";
import { app } from "$lib/hono";

export const handle: Handle = async ({ event, resolve }) => {
  if (event.url.pathname.startsWith("/api")) {
    return await app.handleEvent(event);
  }

  return resolve(event);
};
```

ã—ã‹ã—å®Ÿéš›ã« wrangler ã§ã“ã‚Œã‚’å‹•ã‹ã™ã¨ã€ãƒ«ãƒ¼ãƒˆãŒå­˜åœ¨ã—ãªã„æ—¨ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã€‚
ãªã®ã§ã€å®Ÿéš›ã«ãƒ«ãƒ¼ãƒˆã‚’å®šç¾©ã—ã¦ã‚„ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

```ts :src/route/api/[...rest]/+server.ts
import { app } from "$lib/api/server.ts";

export const GET = async (event) => {
  return await app.handleEvent(event);
};

export const POST = GET;
export const PUT = GET;
```

ã¡ãªã¿ã«ã“ã®ã‚¨ãƒ©ãƒ¼ã¯ Hono ã«é™ã‚‰ãšã€yoga ã§ã‚‚ tRPC ã§ã‚‚å‡ºãŸã®ã§ã€hook ã§å‡¦ç†ã™ã‚‹ã®ã¯æ‚ªæ‰‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚

## env ã‚„ context ã‚’ SvelteKit å´ã‹ã‚‰ Hono ã¸æ¸¡ã™

Hono ã§ã¯`executionCtx`ã‚„`env`ã‚’é€šã—ã¦ Cloudflare ã® KV ã‚„ R2ã€D1ã€ç’°å¢ƒå¤‰æ•°ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
ã“ã‚“ãªæ„Ÿã˜

```ts
import { Hono } from 'hono';

const app = new Hono();

app.post('/', async (c) => {
  const key = 'example_key' as const satisfies string;
  const result  = c.env.BUCKET.get(key);
  c.executionCtx.waitUntil(
      c.env.KV.put(key, data);
  )
  return c.jsonT({result}, 200);
};
```

ã ã‘ã©ã€SvelteKit ã®`load`é–¢æ•°ã‹ã‚‰`app.handleEvent`ã‚’ä½¿ã£ã¦ hono ã« event ã‚’æ¸¡ã—ã¦ã—ã¾ã†ã¨ã€hono ã‹ã‚‰ã¯`env`ã‚„`context`ã«ã†ã¾ãã‚¢ã‚¯ã‚»ã‚¹ãŒã§ããªã„ã€‚
ãªã®ã§ã€ä¸Šè¨˜ã®`+server.ts`é–¢æ•°ã‚’ä¿®æ­£ã—ã¦ã€ã†ã¾ã`env`ã‚„`context`ã‚’æ¸¡ã—ã¦ã‚„ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

ã¨ã“ã‚ã§ã€SvelteKit ã® load é–¢æ•°ã§ã¯`env`ã‚„`context`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãã«ã¯`platform`å¤‰æ•°ã‚’çµŒç”±ã™ã‚‹ã“ã¨ã«ãªã£ã¦ã„ã‚‹ã€‚

https://developers.cloudflare.com/pages/framework-guides/deploy-a-svelte-site/#sveltekit-cloudflare-configuration

ã¤ã¾ã‚Š`platform`å¤‰æ•°ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–ã‚Šå‡ºã—ã¦ hono å´ã«ã©ã†ã«ã‹ã—ã¦æ¸¡ã—ã¦ã‚„ã‚Œã°è‰¯ã„ã®ã§ã‚ã‚‹ã€‚

ã©ã†ã™ã‚‹ã£ã¦ï¼Ÿ
`app.handleEvent`ã®ä»£ã‚ã‚Šã«`app.fetch`ã‚’ä½¿ã†ã€‚
`app.fetch`ã ã¨ã€`request`ã‚’æ¸¡ã™ã¨ãã«ã€`env` ã‚„ `context` ã‚‚æ˜ç¤ºçš„ã«æ¸¡ã›ã‚‹ã®ã ^[å¿µã®ç‚ºè§¦ã‚Œã¦ãŠãã¨ã€`app.handleEvent`ã‚’ä½¿ã£ã¦ã‚‚`platform`ã¯å–ã‚Šå‡ºã™ã“ã¨ãŒã§ãã‚‹ã€‚ãªãœãªã‚‰`app.handleEvent`ã¯å¼•æ•°ã®`event`ã‚’`c.executionCtx`ã«æ ¼ç´ã™ã‚‹ãŸã‚ã€‚ã¤ã¾ã‚Š`c.executionCtx?.platform?.env?.BUCKET`ã®ã‚ˆã†ã«ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã¯ä¸€å¿œã§ãã‚‹ã€‚ãŸã ã€Hono ã£ã½ããªã„]ã€‚

https://hono.dev/api/hono#fetch

ã¾ã‚ã“ã“ã‚‰è¾ºã®é•ã„ã¯ã‚½ãƒ¼ã‚¹ã‚’å®Ÿéš›ã«èª­ã‚“ã§ã¿ã‚‹ã®ãŒæ—©ã„ã¨æ€ã†ã€‚
https://github.com/honojs/hono/blob/94812fcf2db49bc26dd5e421610433e7510c0529/src/hono-base.ts#L347-L353

ã¨ã„ã†ã‚ã‘ã§æ›¸ãæ›ãˆãŸ`+server.ts`ãŒã“ã¡ã‚‰

```ts :src/route/api/[...rest]/+server.ts
import { app, type HonoBindings } from "$lib/api/server.ts";

export const GET = async ({ request, platform }) => {
  const Env = {
    ...platform?.env,
    ...(platform?.caches ? { caches: platform.caches } : {}),
  } as const satisfies HonoBindings;

  return await app.fetch(request, Env, platform?.context);
};

export const POST = GET;
export const PUT = GET;
```

ã¡ã‚ƒã‚“ã¨è£œå®ŒãŒåŠ¹ãã‚ˆã†ã«`HonoBindings`ã‚’å®šç¾©ã—ã¦ãŠã(å®šç¾©ã¯ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å‚ç…§)ã€‚
ã“ã®`HonoBindings`ã‚’ Hono ã® app åˆæœŸåŒ–æ™‚ã«æ¸¡ã—ã¦ã‚„ã‚Œã°ã€Hono ã§ãƒ«ãƒ¼ãƒˆã‚’å®šç¾©ã™ã‚‹ã¨ãã«ã‚‚å‹è£œå®ŒãŒã§ã¦ã†ã¾ãã„ãã€‚
ã¤ã„ã§ã«ã€API ã‚’å©ããŸã‚ã®`hc`ã‚’ `hooks.server.ts`ã§å®šç¾©ã—ã¦ãŠãã¨ã€`locals`çµŒç”±ã§ä»–ã®ãƒ«ãƒ¼ãƒˆã«ã‚ã‚‹`load`é–¢æ•°ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

```ts :src/lib/api/server.ts
import { Hono } from "hono";

export type HonoBindings = Partial<
  App.Platform["env"] & { caches: App.Platform["caches"] }
>;

export const app = new Hono<{ Bindings: HonoBindings }>().basePath("/api");

const route = app.get("/hello", async (c) => {
  const result = c?.env?.BUCKET?.get("hello");
  return c.jsonT({ result });
});

export type AppType = typeof route;
```

```ts :src/lib/api/client.ts
import type { AppType } from "./server";
import { hc } from "hono/client";

export function getClient({ fetch = globalThis.fetch } = {}) {
  return hc<AppType>("/api", { fetch });
}
```

```ts :src/hooks.server.ts
import { getClient } from "$lib/api/client";
import { User } from "$lib/type";

export const handle = async ({ event, resolve }) => {
  /** hookã®ãªã‹ã§èªè¨¼ç³»ã®APIã‚’å©ã„ãŸã‚Šã™ã‚‹ã¨ç„¡é™ãƒ«ãƒ¼ãƒ—ã«é™¥ã‚‹ã®ã§ã€å³resolveã™ã‚‹ */
  if (event.url.pathname.startsWith("/api")) {
    return resolve(event);
  }

  event.locals.honoClient = getClient({ fetch: event.fetch });

  /** ... */

  return resolve(event);
};
```

# ã¾ã¨ã‚

Happy Coding!
è³ªå•ç­‰ã‚ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆã«ã©ã†ãã€‚
